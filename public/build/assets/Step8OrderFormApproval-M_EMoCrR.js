import{u as re,r as c,j as e,c as te}from"./app-CkbwHOkf.js";import{b as H,ap as L,aq as ie,B as ae,_ as de,F as ne,c as oe}from"./index-R2fUhcwH.js";import{t as $,c as s}from"./glass-theme-CCnqi7lL.js";import{D as le}from"./DocusealEmbed-DHc16Xlt.js";import{u as ce}from"./useManufacturers-BPT5VYH2.js";import"./index.esm-DpsOu67m.js";import"./Button-2TyLRw72.js";import"./index-Dp3B9jqt.js";import"./clsx-B-dksMZM.js";import"./card-mI4OQcp1.js";import"./utils-J8bI0sT-.js";import"./index-DNM8Gtkt.js";import"./api-CXAezOed.js";import"./loader-circle-CzGXBM_P.js";import"./createLucideIcon-HYdXrwBu.js";import"./circle-alert-D5RtSiPV.js";import"./circle-check-big-BZwOB0cM.js";function Te({formData:i,updateFormData:O,onNext:C,onSkip:me,products:b,providers:xe=[],facilities:pe=[],errors:A}){var V,Y;let n="dark",r=$.dark;try{n=re().theme,r=$[n]}catch{}const{getManufacturerByName:G}=ce(),[M,R]=c.useState(!1),[y,P]=c.useState(!1),[q,B]=c.useState(!1),[v,E]=c.useState(null),[J,T]=c.useState(!1),[Q,K]=c.useState(null),[w,W]=c.useState(!1),a=(()=>{if(!i.selected_products||i.selected_products.length===0)return null;const t=i.selected_products[0];return t!=null&&t.product_id?b.find(o=>o.id===t.product_id):null})(),u=a!=null&&a.manufacturer?G(a.manufacturer):null,S=(u==null?void 0:u.has_order_form)===!0||(u==null?void 0:u.order_form_template_id);i.ivr_required!==!1&&i.ivr_bypass_reason;const U=()=>{var p;if(!((p=i.selected_products)!=null&&p.length))return{subtotal:0,tax:0,shipping:0,total:0,itemBreakdown:[]};let t=0,o=0;const d=[];for(const m of i.selected_products){const j=b.find(F=>F.id===m.product_id);if(!j)continue;const _=m.quantity||1,I=m.size,k=j.msc_price||j.price_per_sq_cm||0;let N=0;if(I){const F=parseFloat(I);isNaN(F)?N=k*_:N=F*k*_}else N=k*_;t+=N,o+=_,d.push({product_id:j.id,product_name:j.name,quantity:_,unit_price:k,total_price:N,size:I})}const l=t*.08,x=t>500?0:15,g=t+l+x;return{subtotal:Math.round(t*100)/100,tax:Math.round(l*100)/100,shipping:Math.round(x*100)/100,total:Math.round(g*100)/100,totalQuantity:o,itemBreakdown:d}},f=U(),h=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t);console.log("Step 8 - Selected Product:",{name:a==null?void 0:a.name,manufacturer:a==null?void 0:a.manufacturer,manufacturer_id:a==null?void 0:a.manufacturer_id,hasOrderForm:S,pricing:f}),console.log("Step 8 - Pricing Debug:",{formDataSelectedProducts:i.selected_products,products:b,selectedProduct:a,calculatePricingResult:U()}),(V=i.selected_products)!=null&&V.length&&(console.log("Step 8 - Detailed Pricing Debug:"),i.selected_products.forEach((t,o)=>{const d=b.find(l=>l.id===t.product_id);console.log(`Item ${o}:`,{product_id:t.product_id,quantity:t.quantity,size:t.size,product:d?{id:d.id,name:d.name,price_per_sq_cm:d.price_per_sq_cm,msc_price:d.msc_price,national_asp:d.national_asp}:"Product not found",calculated_total:d?parseFloat(t.size||"0")*(d.msc_price||d.price_per_sq_cm||0)*(t.quantity||1):0})})),c.useEffect(()=>{i.order_form_completed_at?P(!0):i.order_form_skipped&&B(!0)},[i.order_form_completed_at,i.order_form_skipped]),c.useEffect(()=>{!S&&!y&&!q&&z()},[S,y,q]);const X=()=>{R(!0)},z=()=>{O({order_form_skipped:!0,order_form_skipped_at:new Date().toISOString()}),B(!0),setTimeout(()=>{C()},1500)},Z=async t=>{T(!0);try{console.log("ðŸŽ‰ Order form completed:",t);const o=t.submission_id||t.id||"unknown";O({order_form_submission_id:o,order_form_completed_at:new Date().toISOString()});try{const d=await te.post("/api/v1/order-form/process-completion",{submission_id:o,episode_id:i.episode_id,ivr_submission_id:i.docuseal_submission_id,form_data:i,completion_data:t});d.data.success&&K(d.data)}catch(d){console.warn("Order form processing API call failed (non-critical):",d)}P(!0),setTimeout(()=>{C()},2e3)}catch(o){console.error("Error processing order form completion:",o),E("Form completed but there was an error processing the submission.")}finally{T(!1)}},D=t=>{E(t),T(!1)},ee=()=>{C()},se=t=>{O({admin_note:t})};return a?S?q?e.jsxs("div",{className:s("text-center py-12",r.glass.card,"rounded-lg p-8"),children:[e.jsx(L,{className:s("h-12 w-12 mx-auto mb-4 text-blue-500")}),e.jsx("h3",{className:s("text-lg font-medium mb-2",r.text.primary),children:"Order Form Skipped"}),e.jsx("p",{className:s("text-sm",r.text.secondary),children:"You chose to skip the optional order form review."}),e.jsx("p",{className:s("text-sm mt-2",r.text.secondary),children:"Proceeding to final review..."})]}):y?e.jsxs("div",{className:s("text-center py-12",r.glass.card,"rounded-lg p-8"),children:[e.jsx(H,{className:s("h-16 w-16 mx-auto mb-4 text-green-500")}),e.jsx("h3",{className:s("text-xl font-medium mb-2",r.text.primary),children:"Order Form Completed Successfully"}),e.jsx("p",{className:s("text-sm",r.text.secondary),children:"The order form has been reviewed and submitted."}),Q&&e.jsx("div",{className:s("mt-4 p-3 rounded-lg",n==="dark"?"bg-green-900/20 border border-green-800":"bg-green-50 border border-green-200"),children:e.jsx("div",{className:"text-sm space-y-1",children:e.jsxs("p",{className:s("font-medium",r.text.primary),children:["Submission #",Q.submission_id||i.order_form_submission_id]})})}),e.jsx("p",{className:s("text-sm mt-3",r.text.secondary),children:"Proceeding to final review..."}),e.jsxs("button",{onClick:ee,className:s("mt-4 inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors",n==="dark"?"bg-blue-700 hover:bg-blue-600 text-white":"bg-blue-600 hover:bg-blue-700 text-white"),children:["Continue to Review",e.jsx(ie,{className:"ml-2 h-4 w-4"})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:s("text-xl font-semibold",r.text.primary),children:"Review Order Form"}),e.jsx("p",{className:s("text-sm mt-1",r.text.secondary),children:"Optional step to review and confirm all order details"})]}),e.jsxs("div",{className:s("p-4 rounded-lg",r.glass.card),children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("h3",{className:s("text-lg font-medium",r.text.primary),children:[e.jsx(ae,{className:"inline mr-2 h-5 w-5"}),"Order Summary"]})}),i.selected_products&&i.selected_products.length>0?e.jsxs("div",{className:"space-y-3",children:[i.selected_products.map((t,o)=>{const d=b.find(m=>m.id===t.product_id);if(!d)return null;const l=t.quantity||1,x=t.size,g=d.msc_price||d.price_per_sq_cm||0;let p=0;if(x){const m=parseFloat(x);isNaN(m)?p=g*l:p=m*g*l}else p=g*l;return e.jsxs("div",{className:s("flex justify-between items-center p-3 rounded-lg","bg-white/5"),children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:s("font-medium",r.text.primary),children:d.name}),e.jsxs("div",{className:s("text-sm",r.text.secondary),children:[e.jsxs("p",{children:["Qty: ",l]}),x&&e.jsxs("p",{children:["Size: ",x," cmÂ²"]}),e.jsxs("p",{children:["Price: ",h(g),"/cmÂ²"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("p",{className:s("font-semibold",r.text.primary),children:h(p)})})]},o)}),e.jsxs("div",{className:s("border-t pt-3 space-y-2",r.glass.border),children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:s("text-sm",r.text.secondary),children:"Subtotal:"}),e.jsx("span",{className:s("text-sm",r.text.primary),children:h(f.subtotal)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:s("text-sm",r.text.secondary),children:"Tax (8%):"}),e.jsx("span",{className:s("text-sm",r.text.primary),children:h(f.tax)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:s("text-sm",r.text.secondary),children:"Shipping:"}),e.jsx("span",{className:s("text-sm",r.text.primary),children:h(f.shipping)})]}),e.jsxs("div",{className:s("flex justify-between pt-2 border-t",r.glass.border),children:[e.jsx("span",{className:s("font-semibold",r.text.primary),children:"Total Bill:"}),e.jsx("span",{className:s("text-lg font-bold",r.text.primary),children:h(f.total)})]})]})]}):e.jsx("p",{className:s("text-sm",r.text.secondary),children:"No products selected"})]}),e.jsxs("div",{className:s("p-4 rounded-lg",r.glass.card),children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:s("text-lg font-medium",r.text.primary),children:[e.jsx(de,{className:"inline mr-2 h-5 w-5"}),"Admin Notes"]}),e.jsx("button",{onClick:()=>W(!w),className:s("text-sm px-3 py-1 rounded-md transition-colors",w?n==="dark"?"bg-blue-700 text-white":"bg-blue-600 text-white":n==="dark"?"bg-gray-700 text-gray-300 hover:bg-gray-600":"bg-gray-200 text-gray-700 hover:bg-gray-300"),children:w?"Hide":"Add Note"})]}),w&&e.jsxs("div",{className:"mt-3",children:[e.jsx("textarea",{value:i.admin_note||"",onChange:t=>se(t.target.value),placeholder:"Add any additional notes or special instructions for this order...",className:s("w-full p-3 rounded-lg border resize-none","focus:ring-2 focus:ring-blue-500 focus:border-blue-500",n==="dark"?"bg-gray-800 border-gray-700 text-white placeholder-gray-400":"bg-white border-gray-300 text-gray-900 placeholder-gray-500"),rows:4}),e.jsx("p",{className:s("text-xs mt-1",r.text.muted),children:"This note will be included with the order submission."})]})]}),!M&&!v&&e.jsxs("div",{className:s("p-4 rounded-lg",r.glass.card),children:[e.jsx("p",{className:s("text-sm mb-4",r.text.secondary),children:"You can review the manufacturer's order form or skip this optional step."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:X,className:s("inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors",n==="dark"?"bg-blue-700 hover:bg-blue-600 text-white":"bg-blue-600 hover:bg-blue-700 text-white"),children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Review Order Form"]}),e.jsxs("button",{onClick:z,className:s("inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors",n==="dark"?"bg-gray-700 hover:bg-gray-600 text-gray-300":"bg-gray-300 hover:bg-gray-400 text-gray-700"),children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Skip This Step"]})]})]}),M&&!y&&!v&&e.jsx("div",{className:s("rounded-lg",r.glass.card),children:e.jsxs("div",{className:"relative",children:[J&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10 rounded-lg",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg text-center max-w-sm",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-900 font-medium",children:"Processing Order Form..."}),e.jsx("p",{className:"text-gray-600 text-sm mt-1",children:"Finalizing your order details"})]})}),e.jsx(le,{manufacturerId:((Y=a==null?void 0:a.manufacturer_id)==null?void 0:Y.toString())||"1",productCode:(a==null?void 0:a.code)||"",documentType:"OrderForm",formData:i,episodeId:i.episode_id?parseInt(i.episode_id):void 0,onComplete:Z,onError:D,className:"w-full h-full min-h-[600px]"})]})}),v&&e.jsx("div",{className:s("p-4 rounded-lg border",n==="dark"?"bg-red-900/20 border-red-800":"bg-red-50 border-red-200"),children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(oe,{className:s("h-5 w-5 mt-0.5 flex-shrink-0 mr-3",n==="dark"?"text-red-400":"text-red-600")}),e.jsxs("div",{children:[e.jsx("h4",{className:s("text-sm font-medium",n==="dark"?"text-red-300":"text-red-900"),children:"Error Loading Order Form"}),e.jsx("p",{className:s("text-sm mt-1",n==="dark"?"text-red-400":"text-red-700"),children:v}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx("button",{onClick:()=>{E(null),R(!1)},className:s("text-sm underline",n==="dark"?"text-red-300":"text-red-600"),children:"Try Again"}),e.jsx("span",{className:s("text-sm",n==="dark"?"text-red-400":"text-red-700"),children:"or"}),e.jsx("button",{onClick:z,className:s("text-sm underline",n==="dark"?"text-red-300":"text-red-600"),children:"Skip This Step"})]})]})]})}),A.order_form&&e.jsx("div",{className:s("p-4 rounded-lg border",n==="dark"?"bg-red-900/20 border-red-800":"bg-red-50 border-red-200"),children:e.jsx("p",{className:s("text-sm",n==="dark"?"text-red-400":"text-red-600"),children:A.order_form})})]}):e.jsxs("div",{className:s("text-center py-12",r.glass.card,"rounded-lg p-8"),children:[e.jsx(H,{className:s("h-12 w-12 mx-auto mb-4 text-green-500")}),e.jsx("h3",{className:s("text-lg font-medium mb-2",r.text.primary),children:"No Order Form Required"}),e.jsxs("p",{className:s("text-sm",r.text.secondary),children:[a==null?void 0:a.name," does not require an additional order form."]}),e.jsx("p",{className:s("text-sm mt-2",r.text.secondary),children:"Proceeding to final review..."})]}):e.jsx("div",{className:s("text-center py-12",r.text.secondary),children:e.jsx("p",{children:"Please select a product first"})})}export{Te as default};
