import{r as m,j as e}from"./app-CkbwHOkf.js";import{i as L}from"./index.esm-DpsOu67m.js";import{B as F}from"./Button-2TyLRw72.js";import{C as v,a as S,b as O,c as M}from"./card-mI4OQcp1.js";import{c as P}from"./index-Dp3B9jqt.js";import{c as N}from"./utils-J8bI0sT-.js";import{t as Y}from"./index-DNM8Gtkt.js";import{a as I}from"./api-CXAezOed.js";import{L as E}from"./loader-circle-CzGXBM_P.js";import{C as B}from"./circle-alert-D5RtSiPV.js";import{C as G}from"./circle-check-big-BZwOB0cM.js";const V=P("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),x=m.forwardRef(({className:o,variant:i,...l},n)=>e.jsx("div",{ref:n,role:"alert",className:N(V({variant:i}),o),...l}));x.displayName="Alert";const $=m.forwardRef(({className:o,...i},l)=>e.jsx("h5",{ref:l,className:N("mb-1 font-medium leading-none tracking-tight",o),...i}));$.displayName="AlertTitle";const h=m.forwardRef(({className:o,...i},l)=>e.jsx("div",{ref:l,className:N("text-sm [&_p]:leading-relaxed",o),...i}));h.displayName="AlertDescription";const se=({manufacturerId:o,templateId:i,productCode:l,documentType:n="IVR",formData:b={},episodeId:y,onComplete:c,onError:j,className:p="",debug:g=!1})=>{const A={status:"loading",submissionSlug:null,error:null,progress:"Initializing..."},T=(s,r)=>{switch(r.type){case"SET_LOADING":return{...s,status:"loading",progress:r.payload,error:null};case"SET_READY":return{...s,status:"ready",submissionSlug:r.payload,progress:"Form ready!"};case"SET_ERROR":return{...s,status:"error",error:r.payload};case"SET_COMPLETED":return{...s,status:"completed"};default:return s}},[t,d]=m.useReducer(T,A),f=m.useRef(!0),R=async()=>{var s,r,D,_,k;try{d({type:"SET_LOADING",payload:"Creating form..."});const u={manufacturerId:o,templateId:i,productCode:l,documentType:n,formData:b,...y&&{episode_id:y}};g&&console.log("🚀 Creating DocuSeal submission:",u);const a=await I.post("/api/v1/quick-request/docuseal/test-mapping",u);if(!f.current)return;if(a.success&&((s=a.data)!=null&&s.slug))d({type:"SET_READY",payload:a.data.slug}),g&&(console.log("✅ DocuSeal submission created:",a.data),console.log("Form URL:",a.data.embed_url),console.log("Fields mapped:",a.fields_mapped),console.log("Mapping method:",a.mapping_method));else if(a.slug)d({type:"SET_READY",payload:a.slug});else throw new Error(a.error||a.message||"Failed to create submission")}catch(u){if(console.error("❌ DocuSeal submission error:",u),!f.current)return;const a=((D=(r=u.response)==null?void 0:r.data)==null?void 0:D.message)||((k=(_=u.response)==null?void 0:_.data)==null?void 0:k.error)||u.message||"Failed to load form";d({type:"SET_ERROR",payload:a}),j==null||j(a)}},w=m.useCallback(s=>{if(s.origin==="https://docuseal.com")try{const r=typeof s.data=="string"?JSON.parse(s.data):s.data;r.type==="docuseal.completed"&&(g&&console.log("✅ DocuSeal form completed:",r),d({type:"SET_COMPLETED"}),c==null||c(r.payload||r))}catch(r){console.error("Error handling DocuSeal message:",r)}},[g,c]);m.useEffect(()=>(f.current=!0,window.addEventListener("message",w),R(),()=>{f.current=!1,window.removeEventListener("message",w)}),[]);const C=()=>{d({type:"SET_LOADING",payload:"Retrying..."}),R()};return t.status==="loading"?e.jsxs("div",{className:`flex flex-col items-center justify-center p-8 min-h-[400px] bg-gray-50 dark:bg-gray-900 rounded-lg ${p}`,children:[e.jsx(E,{className:"w-8 h-8 animate-spin text-blue-600 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"Preparing Your Form"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-center",children:t.progress}),y&&e.jsx("div",{className:"mt-4 px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-sm rounded-full",children:"FHIR Enhanced"})]}):t.status==="error"?e.jsx(v,{className:p,children:e.jsxs(S,{className:"pt-6",children:[e.jsxs(x,{variant:"destructive",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsxs(h,{children:[e.jsx("strong",{children:"Failed to Load Form:"})," ",t.error]})]}),e.jsxs(F,{onClick:C,variant:"outline",className:"mt-4",children:[e.jsx(E,{className:"w-4 h-4 mr-2"}),"Try Again"]})]})}):t.status==="completed"?e.jsx(v,{className:p,children:e.jsx(S,{className:"pt-6",children:e.jsxs(x,{className:"border-green-200 bg-green-50",children:[e.jsx(G,{className:"h-4 w-4 text-green-600"}),e.jsxs(h,{className:"text-green-800",children:[e.jsx("strong",{children:"Form Completed Successfully!"})," Your ",n," has been submitted and saved."]})]})})}):e.jsxs(v,{className:p,children:[e.jsx(O,{children:e.jsxs(M,{children:[n," Form"]})}),e.jsx(S,{children:t.submissionSlug?e.jsxs("div",{className:"space-y-4",children:[g&&e.jsx(x,{children:e.jsxs(h,{children:["Debug: Submission Slug = ",t.submissionSlug]})}),e.jsx(L,{src:`https://docuseal.com/s/${t.submissionSlug}`,email:b.integration_email||b.patient_email,onComplete:s=>{console.log("DocuSeal form completed:",s),d({type:"SET_COMPLETED"}),c==null||c(s),Y.success(`${n} form completed successfully!`)},customCss:`
                .form-container {
                  background-color: #ffffff;
                  border-radius: 0.5rem;
                }
                .submit-form-button {
                  background-color: rgb(59 130 246);
                  border-radius: 0.375rem;
                  font-weight: 500;
                }
                .submit-form-button:hover {
                  background-color: rgb(37 99 235);
                }
                .field-area-active {
                  border-color: rgb(59 130 246);
                }
              `})]}):e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(E,{className:"h-8 w-8 animate-spin text-gray-400"}),e.jsxs("span",{className:"ml-3 text-gray-600",children:["Preparing ",n," form..."]})]})})]})};export{x as A,se as D,h as a};
